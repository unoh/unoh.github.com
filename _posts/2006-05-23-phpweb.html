---
layout: post
title: "PHPで書かれたwebサービスを高速化する"
---
{% raw %}
尾藤正人です。<br /><br />アクセス数の多いコンシューマ向けの web サービスは、処理速度がかなり重要になってきます。<br />応答速度が遅いと使用しているユーザにとってストレスになりますし、<br />処理に時間がかかればサーバに対する負荷も高くなります(厳密に言うと違う)。<br /><br />そこでウノウではいろいろな工夫をして処理速度の高速化を行っています。<br /><br />一口に高速化といってもいろいろな要素がありますが、大きく分けて3つの段階があります。<br /><br />・ハードウェアによる高速化<br />・ソフトウェアによる高速化<br />・プログラムの工夫による高速化<br /><br />しかし、これら3つは独立ではなく、互いに影響しあっているので完全に分けて考えることはできません。<br />それぞれがどのような部分に影響を与えているのか、ちゃんと理解してチューニングすることが大事です。<br /><br />ただし、高速化するときに忘れていけないのが、高可用性です。<br />いくら高速に動作しても安定して動作しないのであれば、導入するべきではありません。<br /><br />例えばCPUをオーバークロックで高速に動作させても1日に1回落ちるようではwebサービスとして成り立ちませんから、こういう高速化は行いません。<br /><br />・ハードウェアによる高速化<br /><br />お金をかければ速くなります。(^^;<br />ただ闇雲に高価なマシンを買えばいいというものではありません。<br /><br />あまりお金のないベンチャー企業は、そこそこのマシンを使ってソフトウェアの方で頑張ることになります。<br /><br />・ソフトウェアによる高速化<br /><br />ここでいうソフトウェアの高速化はプログラムを書かない段階で、既存ソフトウェアの導入、設定、アップグレード等によって高速化を行います。<br /><br />- ファイルシステムに ext3 を"使わない"<br /><br />ext3 はファイル数が増えると顕著に処理速度が遅くなります。<br />ReiserFS, JFS, XFS等はファイル数が増えても高速に動作します。<br /><br />- DBのチューニング<br /><br />他に詳しい解説があるので、ここでは割愛。<br />書くと墓穴を掘りそうなので。<br /><br />- mod_deflateを使う<br /><br />htmlはテキストデータなので圧縮するとかなり小さくなります。<br />使用する帯域が減るということはレスポンスが速くなるということです。<br />サーバ側で圧縮処理が必要になりますが、体感速度が全然違います。<br />ぜひ、導入しましょう。<br /><br />- .htaccessを使わない<br /><br />.htaccessを使うとアクセスの度に読み込みが行われるので遅くなります。<br />.htaccessに書く内容はすべてhttpd.confに書くようにしましょう。<br /><br />- apacheはpreforkで動作させる<br /><br />これは高速化ではなく、むしろ鈍速化。<br />以前フォト蔵でworkerで動作させていたのですが、不安定だったのでpreforkに戻しました。<br />少しぐらい速くなってもやはり安定性が重要です。<br /><br />- <a href="http://sourceforge.net/projects/eaccelerator/">eAccelerator</a>(PHP拡張)を使う<br /><br /><a href="http://sourceforge.net/projects/eaccelerator/">eAccelerator</a>を使うとコンパイル済みスクリプトをキャッシュしてくれるようになるので、毎回バイトコンパイルする必要がなくなります。<br />スクリプトが更新されても自動的にキャッシュファイルも更新してくれるので動作には全く問題ありません。<br /><br />- Zend Optimizer(PHP拡張)を使う<br /><br />Zend Optimizerを使うとPHPを高速に実行してくれます。<br /><br />Zend OptimizerとeAcceleratorは共存可能です。<br />フォト蔵ではずっとZend OptimizerとeAcceleratorを使用していますが、問題が起こったことは1回もありません。<br /><br />Yahooのapacheもpreforkで動作しているようですし。<br /><br /><br />いろいろ書いてたら長くなってので今日はこの辺で。<br />プログラム側でもいろいろ工夫をしていますが、それはまた後日書きます。
{% endraw %}
