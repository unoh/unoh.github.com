---
layout: post
title: "ベンチャー流サーバ構築のススメ(ソフトウェア編)"
---
尾藤正人です<br />
<br />
ラボブログではウノウのエンジニアで1日1人1エントリ(早く書くのはあり)で書いてます。おかげさまでウノウも順調にエンジニアの数が増えて、僕の順番に回ってくるのが少しずつ遅くなってきました。でもまだまだウノウでは<a href="http://www.unoh.net/recruit.html">エンジニアを大募集中</a>です!!我こそはと思う方はぜひご連絡ください。<br />
<br />
前回の<a href="http://labs.unoh.net/2006/06/post_21.html">ベンチャー流サーバ構築のススメ(ネットワーク編)</a>ではネットワーク周りについて書きました。前回のエントリで言ったように、今回はソフトウェア周りのことについて書きたいと思います。<br />
<br />
ソフトウェア周りで重要なのは、<strong>同じ構成にする</strong>、これにつきます。web サーバにだけ apache をインストールしたりとか、DB サーバにだけ MySQL をインストールしたりだとかいうことはしません。全てのサーバに同じパッケージ、同じプログラムをインストールします。それによる管理コストの軽減ははかりしれないものがあります。役割の違いによって、設定ファイルまで全く同じにはできませんが、極力同じにします。理想は<strong>全てのサーバがマスターサーバ</strong>です。<br />
<br />
<strong>・Linux はインストールしない、コピーする</strong><br />
<br />
Linux のインストールは最初の1台だけです。後は全てコピーします。<br />
<br />
コピーに使用するのは dump, restore というコマンドを使います。ウノウのサーバの場合、ファイルシステムが xfs ですので、xfs 用の xfsdump, xfsrestore を使用します。<br />
<br />
* xfs にしている理由については<a href="http://labs.unoh.net/2006/05/phpweb.html">PHPで書かれたwebサービスを高速化する</a>をご覧ください<br />
<br />
コピー元のサーバはどれでも構いません。なぜなら全てのサーバが同じファイル構成、マスターサーバだからです。少しぐらい止めても大丈夫なサーバ、webサーバとか DB のスレーブサーバを選びましょう。<br />
<br />
コピー元のサーバにコピー先のサーバの HDD を接続します。後は次のシェルスクリプト1発でコピー完了です。<br />
<br />
<pre class="source_code">
#!/bin/sh
mkfs.ext3 /dev/sdb1 -L /boot
mkfs.xfs -f /dev/sdb2 -L /
mount /dev/sdb1 /w
cp -a /boot/* /w
umount /w
mount /dev/sdb2 /w
xfsdump -a - /| xfsrestore -r - /w
umount /w
</pre><br />
<br />
ものの10分でコピーできます。これでファイルシステムはコピーできたのですが、重要な MBR が書き換わってないので、このままでは起動することができません。そこで、GRUB の入った CD で起動して MBR を書き換えます。<br />
<br />
正確なコマンドは忘れましたが、GRUB が起動して次のようにタイプすると MBR が書き換えられて起動できるようになります。<br />
<br />
<pre class="source_code">
root (hd0,0)
setup (hd0)
</pre><br />
<br />
実はこれをもうちょっと発展させてネットワーク越しで dump, restore できないかなと考えています。<br />
<br />
・サーバを設置<br />
・knoppix のように CD で Linux を起動<br />
・ネットワーク越しで dump, restore<br />
・GRUB で MBR 書き換え<br />
<br />
こういう風にすると既存のサーバを止めて物理的に HDD を繋げる手間もなくなりますし、作業をほぼ半自動化できます。<br />
<br />
<strong>・設定ファイルは極力同期する</strong><br />
<br />
サーバ間での設定の差異は極力なくしまします。例えば apache が動いていないサーバでも httpd.conf は更新します。サーバごとの違いを管理するコストよりも、同期をとるコストの方が圧倒的に低いからです。proxy サーバの設定は若干違いますが。<br />
<br />
サーバの同期を取るために簡単なシェルスクリプトを使っています。シェルスクリプトについては、また次回にでも書きたいと思います。<br />
<br />
<strong>・パッケージのアップデートもコピー</strong><br />
<br />
アップデートパッケージがあった場合に1台1台のマシンでアップデート作業をやるのは大変です。パッケージをアップデートする場合は、1台のサーバでアップデートを行って、残りのマシンには rsync でコピーします。<br />
<br />
新規パッケージインストールの場合は /etc, /var とかにファイルが追加されたりするので、各マシンでインストールするのですが、パッケージアップデートの場合は /usr のファイルが更新されると相場は決まってます。<br />
<br />
ライブラリ系のパッケージの場合は ldconfig を忘れないように注意します。これ忘れるとライブラリの情報が更新されませんので。<br />
<br />
<strong>・ソースからインストールするパッケージは /opt へ</strong><br />
<br />
普通に ./configure; make; make install すると /usr/local にインストールされます。/usr/local にインストールされると別々のパッケージに所属するファイルが /usr/local に入ってしまって、どのファイルがどのパッケージに所属するか分からなくなって管理できなくなってしまいます。なのでソースコードからインストールするソフトウェアは全て /opt/package という風にパッケージごとに分けてインストールします。<br />
<br />
このときに気をつけないといけないのが、環境変数 PATH の設定と /etc/ld.so.conf の設定です。<br />
/opt/package/bin を PATH に追加して、 /opt/package/lib を /etc/ld.so.conf に追加(実際は /etc/ld.so.conf.d にファイルを追加するだけでよい)　します。<br />
<br />
この辺の話は以前に自分のブログで書いたのでよかったら参照してください。<br />
<a href="http://blog.bz2.jp/archives/2006/02/tarball.html">tarballからインストールしたソフトウェアを簡単に管理する</a><br />
<br />
もちろん /opt にインストールする場合も1台のサーバにインストールして、残りは全部コピーです。<br />
<br />
<strong>・アプリケーションのインストールは極力パッケージに任せる</strong><br />
<br />
コアなソフトウェア、パッケージが用意されてないソフトウェア以外は極力パッケージで管理するようにします。ソフトウェアに脆弱性があった場合など、全てのソフトウェアの更新をウォッチすることはできませんから、パッケージで管理できるソフトウェアは全てパッケージで管理するようにします。<br />
<br />
<br />
<br />
今回はサーバ構築のソフトウェア(OS周り)について書きました。次回は今回紹介しきれなかったサーバ管理に使ってるシェルスクリプトのことについて書きたいと思います。
