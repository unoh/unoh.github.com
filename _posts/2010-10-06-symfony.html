---
layout: post
title: "絵文字のためにsymfonyのカスタムハンドラーを作ってみました"
---
{% raw %}
<p>こんにちは、kayです。</p>

<p>携帯サイトのdocomo絵文字が文字と同じ色になっていると気になって気になって仕方がない今日この頃なのですが、YAMLでデフォルトの色を設定して絵文字を出力するときに自動的にその色にしてくれるなんてことをしたいなぁと思っていました。</p>

<p>しかし、sfYaml::load()をすると毎回パースしてしまうのでとっても頻繁に呼び出される絵文字の色にそれを使ってしまうと大変なことになってしまいます。</p>

<p>app.ymlなどのsymfony側の設定YAMLはパース結果をキャッシュしてくれるのですが、それを絵文字の色の設定でもすればいいと大先生に言われましたのでカスタムハンドラーを作って対応することにしました。</p>

<h3>symfonyのビルドインハンドラー</h3>
<p>まず、symfonyにはビルトインハンドラーが多数存在しますが、今回は汎用的に使えるsfDefineEnvironmentConfigHandlerとsfSimpleYamlConfigHandlerを見てみました。</p>

<ul>
<li>
sfDefineEnvironmentConfigHandler<br />
app.ymlのようにdev, prodなどの環境に応じて異なる値が設定できる汎用ハンドラー<br />
この場合環境によって設定が異なる訳ではないのでリッチすぎる
</li>
<li>sfSimpleYamlConfigHandler<br />
パースした結果をキャッシュしてくれるだけのハンドラー<br />
sfConfig::add()をしてくれないので、読みだしただけではsfConfig::get()が使えない</li>
</ul>

<p>結果、sfSimpleYamlConfigHandlerプラスアルファでsfConfig::add()をしてくれるだけでそこそこ使えるものになるなぁと思いました。</p>

<h3>YAMLを用意</h3>
<pre class="code"><code># config/hoge.yml
fuga: 1
foo:
  bar: 2</code></pre>

<h3>config_handlers.ymlを編集</h3>
<p>config_handlers.yml内に、上記のYAMLファイルを読むのに使用するハンドラーを指定します。<br />
ファイルパスを指定しておかないとデバッグモードが無効な状態でエラーになってしまうので要注意です。</p>
<pre class="code"><code>config/hoge.yml:
  class: myHogeConfigHandler
  file: %SF_ROOT_DIR%/lib/config/myHogeConfigHandler.class.php
  param:
    # sfConfig::get()で値を取得する時のキープレフィクス
    prefix: hoge_</code></pre>

<h3>ハンドラー作成</h3>
<p>あくまでも例ですが、下記のようにシンプルに出来ます。</p>
<pre class="code"><code>&lt;?php

class myHogeConfigHandler extends sfYamlConfigHandler
{
    public function execute($configFiles)
    {
        $prefix = strtolower($this->getParameterHolder()->get('prefix', ''));
        $config = self::parseYamls($configFiles);

        $hogeConfig = array();
        foreach ($config as $key => $value) {
            // sfConfig::get()で使うキープレフィックスを付ける
            $hogeConfig[$prefix . $key] = $value;
        }

        // include等した際に同時に中身をsfConfig::add()もするようにする
        return sprintf("&lt;?php\n"
                . "// auto-generated by %s\n"
                . "// date: %s\n"
                . "sfConfig::add(%s);\n",
                __CLASS__,
                date('Y/m/d H:i:s'),
                var_export($hogeConfig, true));
    }
}</code></pre>

<h3>sfConfigCache::import()で設定を読む</h3>
<ul>
<li>sfConfigCache::checkConfig()してキャッシュファイルをインクルードしてくれます</li>
<li>インクルードの帰り値を返してはくれないけどこの場合sfConfig::get()で値を取得出来るようになっているので大丈夫です</li>
</ul>

<p>YAMLの設定値をとにかく読み込ませておきたい場合はApplicationConfiguration::initialize()等に入れておきます</p>
<pre class="code"><code>&lt;?php

abstract class myApplicationConfiguration extends sfApplicationConfiguration
{
    public function initialize()
    {
        $this->getConfigCache()->import('config/hoge.yml', true, true);
    }
}</code></pre>

<h3>sfConfig::get()で設定値を取得</h3>
<ul>
<li>sfConfig::get('hoge_fuga')は1</li>
<li>sfConfig::get('hoge_foo')はarray('bar' => 2)</li>
<li>sfConfig::get('hoge_foo_bar')は2</li>
</ul>
とそれぞれ設定した値を返してくれるようになりました！

<h3>感想</h3>
マスターデータ系はDBではなくYAML等のファイルで設定するのが好きなのですが、その際の問題点を解決出来たので良かったです。みなさまもぜひぜひ使いやすいカスタムハンドラーを作ってみてはいかがでしょうか？
{% endraw %}
