---
layout: post
permalink: /2010/12/06/farmville_-_facebookno15.html
title: "FarmVilleの開発 - FacebookのNo.1ゲームを5週間で作りあげスケールさせた手法"
date: 2010-12-06T23:26:48.00+09:00
tags:
  - "isogawa"
---
<p>こんにちは、五十川です。</p>

<p>2010年12月1日に、ウノウがジンガジャパンとなってから初めてのタイトルとなる<a href="http://news.zynga.co.jp/2010/12/01/farmvillage/">ファームビレッジ</a>がリリースされました。ファームビレッジはFacebookで永らくNo.1の座にある<a href="http://apps.facebook.com/onthefarm/">FarmVille</a>の日本語版ですが、先月そのFarmVille開発のリーダーで、現在はZyngaの共有テクノロジーをリードしている<a href="http://www.amitt.com/">Amitt Mahajan</a>が来日していました。</p>

<p>今回ご紹介するのは、そのAmittが2010年3月のGame Developers Conference（GDC）で行った、<a href="https://www.cmpevents.com/GD10/a.asp?option=G&amp;V=3&amp;id=666324">Rapidly Developing FarmVille - How we built and scaled a #1 Facebook game in 5 weeks</a>と題したプレゼンテーションです。今回Amittの許可を得てそのときのスライドの日本語版を作成しましたので、それに解説を加えてご紹介したいと思います。</p>

<p>なお、スライドのオリジナルは<a href="http://www.gdcvault.com/free/gdc-10">GDC Vault</a>からダウンロード可能で、<a href="http://www.amitt.com/2010/03/30/rapidly-developing-farmville-presentation">Rapidly Developing FarmVille Presentation - Amitt's Space</a>に掲載されているリンクから直接ダウンロードできます。スライドの言葉は簡潔なものが選ばれる傾向にあり、そのまま訳しても意味が伝わらない場合が往々にしてありますので、日本語版の作成にあたって意図的に言葉を変えている点が多々あります。もし翻訳について疑問に思われる箇所がありましたら、オリジナルを参照ください。</p>

<div style="text-align:center;"><object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,28,0" width="425" height="370" id="onlinePlayer257319"><param name="movie" value="http://www.slideboom.com/player/player.swf?id_resource=257319" /><param name="allowScriptAccess" value="always" /><param name="quality" value="high" /><param name="bgcolor" value="#ffffff" /><param name="allowFullScreen" value="true" /><param name="flashVars" value="" /><embed src="http://www.slideboom.com/player/player.swf?id_resource=257319" width="425" height="370" name="onlinePlayer257319" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer"allowScriptAccess="always" quality="high" bgcolor="#ffffff" allowFullScreen="true" flashVars="" ></embed></object><p><a href="http://www.slideboom.com/presentations/257319/FarmVille%E3%81%AE%E9%96%8B%E7%99%BA---Facebook%E3%81%AENo.1%E3%82%B2%E3%83%BC%E3%83%A0%E3%82%925%E9%80%B1%E9%96%93%E3%81%A7%E4%BD%9C%E3%82%8A%E3%81%82%E3%81%92%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%AB%E3%81%95%E3%81%9B%E3%81%9F%E6%89%8B%E6%B3%95">FarmVilleの開発 - FacebookのNo.1ゲームを5週間で作りあげスケールさせた手法</a></p></div>

<p>スライド5までは特に解説は必要ないと思われますので割愛します。なお、ここに登場する数字はいずれもこのプレゼンテーションの作成時点、つまり2010年3月の時点のものである点にご注意ください。</p>

<h3>スライド6-9 開発の効率化</h3>

<p>ここではデベロッパーの作業が遅延する要因とその対処が述べられています。</p>

<p>まず「他のデベロッパーとの協業」ですが、一般的にPC向けのソーシャルゲームでは、クライアントはFlash、サーバは、Zyngaの場合はPHPと、異なるスキルが必要になります。もしデベロッパーがいずれか一方の知識しかない場合は、もう一方のデベロッパーとの協業が必要となり、これが往々にして作業を遅延させる要因になり得ますが、FarmVilleのデベロッパーはいずれもこれら両方のスキルを持っており、こうした問題が回避できたということです。実際この両方のスキルは、現在のZyngaのすべてのデベロッパーに求められるものになっています。</p>

<p>また、通常デベロッパー以外が担当するもの、つまりゲームの仕様であったり、画面デザインなどのアートワークや、そこに表示するストーリーやメッセージなどのテキストといったものが、デベロッパーの作業を妨げる要因として挙げられています。これらが決まらないためにデベロッパーの作業が待ちになってしまうという事態は往々にしてあり得ることですが、まずこのうち仕様については、通常はゲームデザイナーのみがこれを担当しますが、FamVilleではデベロッパー自身もこれを担当できる裁量が与えられました。スライド中の「ゲームデザイナーがすべてを支配しない（Design DOESN'T rule all）」というのがこの箇所です。また、データ主導のゲームデザイン（Data Driven Design）という考え方のもと、ゲームデザイナーがデベロッパーの手を借りずに自らゲームの機能をコントロールできる仕組みが採用されています。これは例えば、ゲームデザイナーが容易に編集できるXMLファイル等にゲームのパラメーター等を分離しておくといった、ごく簡単な方法によって実現できるものです。これと同様に、ストーリーやメッセージといった文字列をプログラムから分離してことで、ゲームデザイナーがそれを容易に変更でき、デベロッパーにとってはその決定や変更に作業を妨げられることがなくなります。これが、スライド中で「文字列テーブル（String Table）」と呼ばれているものです。これはもちろん、国際化を前提としたプログラムにおいてはお馴染みの手法ですが、それ以外にも、特にFacebook向けのゲームの場合には大きな意味を持ちます。Facebookではゲームに対する規約が非常に細かく定められており、かつそれが突然変更され、限られた期限での対応を求められるということがしばしば起こるのですが、こうした手法を用いることで、このような対応が容易になるというわけです。</p>

<h3>スライド10-12 抽象化されたネットワークレイヤー</h3>

<p>ここではクライアントとサーバーの連携について述べられています。Zyngaのゲームアーキテクチャーにはクライアントとサーバーを効率的に連携させる、抽象化されたネットワークレイヤーが用意されており、デベロッパーはこれを利用することで、その実際の連携処理を意識する必要なしに、アプリケーションを容易に実装できるようになっています。</p>

<h3>スライド13 ソーシャルネットワークラッパー</h3>

<p>FacebookのAPIリクエストはソーシャルネットワークラッパーと呼ばれる仕組みの中に一元化されています。FacebookのAPIはその仕様が頻繁に変更されるため、こうして一元化しておくとその変更への対処が容易になります。また、Facebookに限らず、様々なソーシャルネットワークごとに異なるAPIの実装を、ここで共通のインタフェースでアクセスできるようにしておくことで、クロスプラットフォームへの対応が容易になります。</p>

<h3>スライド14-15 QAプロセス</h3>

<p> スライド全体の締めで言われているように、ソーシャルゲームはマラソンであり、常に改修を加え新しい機能を提供し続けていくことが重要ですが、これらを早期にかつトラブルがないようにリリースするためにはQAプロセスが重要になります。FarmVilleでは、Facebook上に用意したテスト用アプリに対して、ソースリポジトリーの最新版が自動テストを経てビルドされる仕組みを構築しており、そこでのスモークテスト、そしてステージング環境でのフルテストを経て本番環境にリリースされるというプロセスを採用しています。</p>

<h3>スライド16-19 サーバーアーキテクチャー</h3>

<p>スライド16にあるように、FarmVilleは20週連続で毎週100万ずつDAU（デイリーアクティブユーザー）が増加するという、驚くべき成長を遂げました。こうした急激なトラフィックの増加に対して、いかにきちんとスケールするサーバーアーキテクチャーを構築するかというのは、ソーシャルゲームの最も重要なポイントのひとつとなっています。スライド18に示されているFarmVilleのアーキテクチャーは、一見ごく常識的なものに見えますが、実際はかなり大胆で野心的なアーキテクチャーとなっています。残念ながらここではその具体的な詳細に触れることができませんので、もしご興味を持たれたかたは是非Zynga Japanの人材採用に応募いただき、その一員になっていただきたいと思います（笑）</p>

<p>スライド19で述べられているのは、Zyngaのゲームアーキテクチャーではアプリケーションレイヤー、つまりゲーム本来の部分の実装を除くすべてのコンポーネントが共通化されており、新しいゲームを開発する際にはアプリケーションレイヤーの実装だけに集中すればよいということです。デベロッパーはスケーラブルなバックエンドやネットワークレイヤー、ソーシャルネットワークラッパーなどがすべて用意された状態から新しいゲームの開発をスタートすることができるのです。</p>

<h3>スライド20-23 ユーザーエクスペリエンスの向上</h3>

<p>ここでは主にユーザーエクスペリエンスの向上について述べられています。ご存知の通りユーザーはゲームが自分の操作に素早く反応することを求めます。この障害になるもののひとつがFacebookのAPIリクエストです。外部へのリクエストは遅く信頼性にも乏しいため、FarmVilleではクライアントが直接APIリクエストを実行することを避け、サーバー側でリクエストを実行してその結果をキャッシュし、さらにそれをクライアント出力に埋め込むといった手法が採られています。同様にデータベースへのリクエストもキャッシュされ、またページプロファイラーと呼ばれる仕組みを使って、キャッシュされていないリクエストを監視することでそれを根絶するといった手法が採られています。</p>

<h3>スライド24-26 障害への対処</h3>

<p>それでもサーバーはダウンします。あるいはFacebookのAPIが利用できない場合というのもあり得ます。そのため、サーバーアーキテクチャーのすべてのレベルを冗長化し、それでも冗長化に限度があるデータベースや、そもそもコントロールが不可能なFacebookのAPIが機能しなくなってしまった場合など、あらゆる事態を想定して、最低限でも動き続けることを目指すというのがスライド24です。そのためFarmVilleでは、スライド25にあるように、すべての機能にON/OFFスイッチ（Kill Switch）を用意しています。そしてもちろん、こうした事態を早期に発見するためには、スライド25のようなサーバーの監視体制と、スライド26にあるようなユーザーの挙動についての仔細なトラッキングが重要になります。</p>

<h3>スライド28 ソーシャルゲームは短距離走ではなくマラソン</h3>

<p>ここで登場する「ソーシャルゲームは短距離走ではなくマラソン（Social games are a marathon not a sprint）」という言葉は、ソーシャルゲームを運用された経験をお持ちのすべてのかたが実感されていることでしょう。長い道のりを走り続けるためには、ローンチの前にはそれがきちんと動作することを確信し、（ちゃんと睡眠をとって！）余裕を持ってローンチすることが重要であるとして、このスライドは結ばれています。</p>

<h3>The slide introduced in this article</h3>

<ul>
  <li>Author: Amitt Mahajan, Zynga Inc.</li>
  <li>Japanese Translation: ISOGAWA, Tadasu, Zynga Japan K.K.</li>
</ul>

<p style="font-style:oblique;">Thank you Amitt for your kind permission of the translation!</p>
